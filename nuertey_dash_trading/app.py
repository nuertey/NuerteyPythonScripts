#***********************************************************************
# @file
#
# Nuertey's first full-blown Dash web application that presents an automatic
# Trading Application dashboard to the user. It effectively allows the user
# to visualize Nuertey's VWAP Stock Trading Algorithm in action. A secondary
# purpose of this script is to illustrate some teaching ideas to Wayo and 
# other dear students.
#
# @note [1] Chose a country from the drop down list for the current news
#           headlines in that country to be displayed to the user. Clicking 
#           on each news item headline will open a tab for that news item 
#           from the news agency of concern. 
#
#       [2] Incoming stock trades as captured in the PostgreSQL database
#           are displayed to the user.
#
#       [3] Incoming stock quotes as captured in the PostgreSQL database
#           are displayed to the user.
#
#       [4] Outgoing customer stock orders generated by the VWAP algorithm
#           and captured in the PostgreSQL database are displayed to the
#           user.
#
#       [5] Within the quotes table, good Buys, that is, "Ask prices less
#           than or equal to the current VWAP" will change color from ...
#           to green.
#
#       [6] Within the quotes table, good Sells, that is, "Bid prices 
#           greater than or equal to the current VWAP" will change color
#           from ... to red.
#
#       [7] The rolling VWAP as calculated and captured in the PostgreSQL 
#           database will be plotted and continuously updated for the user.
#               
# @warning  None
#
#  Created: Amidst the rental and job stresses/uncertainties of July 1st, 
#           2020
#   Author: Nuertey Odzeyem
#**********************************************************************/
import os
import sys
import json
import base64
import datetime
import requests
import psycopg2
import pandas as pd
from http import HTTPStatus
import dash
import dash_table
import dash_core_components as dcc
import dash_html_components as html
from dash.dependencies import Input, Output, State
import plotly.graph_objects as go
from news_config import COUNTRY_CODES

pd.set_option('display.max_rows', 200)
pd.set_option('display.min_rows', 200)
#pd.set_option('display.expand_frame_repr', True)

try:
    print()
    print("Beginning Mr. Nuertey Odzeyem's stock_trading Dash/PostgreSQL database test...")
    print()

    app = dash.Dash(
        __name__, meta_tags=[{"name": "viewport", "content": "width=device-width"}]
    )

    colors = {
        'background': '#111111',
        'text': '#7FDBFF'
    }

    connect_str = "dbname='stock_trading' user='nuertey' host='localhost' " + \
                  "password='krobo2003'"

    connection = psycopg2.connect(connect_str)

    trades = pd.read_sql('select * from trades', connection)
    quotes = pd.read_sql('select * from quotes', connection)
    orders = pd.read_sql('select * from orders', connection)

    country_codes = pd.DataFrame(COUNTRY_CODES)
    codes_dictionary = country_codes.to_dict('list')
    country_code = 'ng' # Default country code = Nigeria for testing and to prick Wayo and Emile's interest.
    culprit_country_name = country_codes.loc[country_codes['value'] == country_code,'label']
    culprit_country_name = next(iter(culprit_country_name), 'no match')

    token = open("../.newsapi_token").read().rstrip('\n')
    news_api_url = f"https://newsapi.org/v2/top-headlines?country={country_code}&apiKey={token}"
    reply = requests.get(news_api_url)

    # API Call to update news
    def update_news():
        the_composed_news = html.Div([html.P('Placeholder Text'),])
        if reply.ok:
            text_data = reply.text
            json_dict = json.loads(text_data)
            if json_dict["totalResults"] > 0:
                df = pd.DataFrame.from_dict(json_dict["articles"])
                df = pd.DataFrame(df[["title", "url"]])
                max_rows = 10
                #pd.set_option('display.max_colwidth', -1)
                the_composed_news = html.Table(
                    className="table-news",
                    children=[
                        html.Tr(
                            children=[
                                html.Td(
                                    children=[
                                        html.A(
                                            className="td-link",
                                            children=df.iloc[i]["title"],
                                            href=df.iloc[i]["url"],
                                            target="_blank",
                                        )
                                    ]
                                )
                            ]
                        )
                        for i in range(min(len(df), max_rows))
                    ],
                )
            else:
                composed_news = "Sorry. No online news articles were discovered for \"{0}\". Check meatspace.".format(culprit_country_name)
                the_composed_news = html.Div(children=composed_news, style={
                    'textAlign': 'center',
                    'color': colors['text']
                })
        else:
            composed_news = f'{reply.status_code} :-> {HTTPStatus(reply.status_code).phrase}'
            reply_json = json.loads(reply.text)
            composed_news = composed_news + "<br>" + json.dumps(reply_json, indent=2))
            the_composed_news = html.Div(children=composed_news, style={
                'textAlign': 'center',
                'color': colors['text']
            })

        return html.Div(
            children=[
                html.P(className="p-news", children="Headlines"),
                html.P(
                    className="p-news float-right",
                    children="Last update : "
                    + datetime.datetime.now().strftime("%H:%M:%S"),
                ),
                the_composed_news,
            ]
        )

    # Create the VWAP trace contrasted with the stock trades price:
    figure1 = go.Figure()
    figure1.add_trace(go.Scatter(x=trades['timestamped'], y=trades['price'],
                        mode='lines+markers',
                        name='Stock Exchange Trades Price'))
    figure1.add_trace(go.Scatter(x=trades['timestamped'], y=trades['volume_weighted_average_price'],
                        mode='lines+markers',
                        name='Volume-Weighted Average Price (VWAP)'))
    figure1.update_layout(
        title="Stock Exchange Trades Price Versus Volume-Weighted Average Price (VWAP)",
        xaxis_title="Timestamp",
        yaxis_title="Price"
    )

    app.layout = html.Div(style={'backgroundColor': colors['background']}, children=[
        # dcc.Interval is a component that will fire a callback periodically. 
        # Use dcc.Interval to update your app in realtime without needing 
        # to refresh the page or click on any buttons.

        # Interval component for live clock updates:
        dcc.Interval(id="interval", interval=1 * 1000, n_intervals=0),

        # Interval component for graph, database tables and price comparison updates:
        dcc.Interval(id="i_tris", interval=1 * 5000, n_intervals=0),

        # Interval component for news updates:
        dcc.Interval(id="i_news", interval=1 * 60000, n_intervals=0),

        html.H1(
            children='Nuertey Odzeyem\'s VWAP Stock Trading Dash Web Application',
            style={
                'textAlign': 'center',
                'color': colors['text']
            }
        ),
        # Left Panel Div
        html.Div(
            className="three columns div-left-panel",
            children=[
                # Div for Left Panel App Info
                html.Div(
                    className="div-info",
                    children=[
                        html.Img(
                            className="logo", src=app.get_asset_url("dash-logo-new.png")
                        ),
                        html.H6(className="title-header", children="FOREX TRADER"),
                        html.P(
                            """
                            This app continually queries csv files and updates Ask and Bid prices
                            for major currency pairs as well as Stock Charts. You can also virtually
                            buy and sell stocks and see the profit updates.
                            """
                        ),
                    ],
                ),
                # Div for realtime clock:
                html.Div(
                    className="div-currency-toggles",
                    children=[
                        html.P(
                            id="live_clock",
                            className="three-col",
                            children=datetime.datetime.now().strftime("%H:%M:%S"),
                        ),
                    ],
                ),
                # Div for dropdown list:
                dcc.Dropdown(
                    id='demo-dropdown',
                    options=COUNTRY_CODES,
                    value=country_code
                ),
                # Div for dropdown list output container:
                html.Div(id='dd-output-container'),
                # Div for News Headlines:
                html.Div(
                    className="div-news",
                    children=[html.Div(id="news", children=update_news())],
                ),
            ],
        ),
        html.Div(children='Extended application description from header here...', style={
            'textAlign': 'center',
            'color': colors['text']
        }),
        # Dash DataTable is an interactive table component designed for 
        # viewing, editing, and exploring large datasets. DataTable is 
        # rendered with standard, semantic HTML <table/> markup, which 
        # makes it accessible, responsive, and easy to style. This component 
        # was written from scratch in React.js specifically for the Dash
        # community. Its API was designed to be ergonomic and its behavior
        # is completely customizable through its properties. 7 months in 
        # the making, this is the most complex Dash component that Plotly
        # has written, all from the ground-up using React and TypeScript. 
        # DataTable was designed with a featureset that allows for Dash
        # users to create complex, spreadsheet driven applications with 
        # no compromises:
        dash_table.DataTable(
            id='stock-trades',
            columns=[{"name": i, "id": i} for i in trades.columns],
            data=trades.to_dict('records'),
        ),
        dash_table.DataTable(
            id='stock-quotes',
            columns=[{"name": i, "id": i} for i in quotes.columns],
            data=quotes.to_dict('records'),
        ),
        dash_table.DataTable(
            id='stock-orders',
            columns=[{"name": i, "id": i} for i in orders.columns],
            data=orders.to_dict('records'),
        ),
        # Div for VWAP trace and trades price graphs:
        dcc.Graph(id='graph-1', 
            figure=figure1
        )
    ])

    # Callback to update country of choice for news headlines:
    @app.callback([Output('dd-output-container', 'children'), Output("news", "children")], [Input('demo-dropdown', 'value')])
    def update_output(value):
        country_code = value
        return 'You have selected "{}" for top news headlines.'.format(value), update_news()

    # Callback to update live clock:
    @app.callback(Output("live_clock", "children"), [Input("interval", "n_intervals")])
    def update_time(n):
        return datetime.datetime.now().strftime("%H:%M:%S")

    # Callback to update news:
    @app.callback(Output("news", "children"), [Input("i_news", "n_intervals")])
    def update_news_div(n):
        return update_news()

    # Callback to update trades table and generated graph:
    @app.callback([Output('stock-trades', 'data'), Output('graph-1', 'figure')], [Input("i_tris", "n_intervals")])
    def update_trades_and_graph(n):
        trades = pd.read_sql('select * from trades', connection)

        # Create the VWAP trace contrasted with the stock trades price:
        fig = go.Figure()
        fig.add_trace(go.Scatter(x=trades['timestamped'], y=trades['price'],
                            mode='lines+markers',
                            name='Stock Exchange Trades Price'))
        fig.add_trace(go.Scatter(x=trades['timestamped'], y=trades['volume_weighted_average_price'],
                            mode='lines+markers',
                            name='Volume-Weighted Average Price (VWAP)'))
        fig.update_layout(
            title="Stock Exchange Trades Price Versus Volume-Weighted Average Price (VWAP)",
            xaxis_title="Timestamp",
            yaxis_title="Price"
        )

        return trades.to_dict('records'), fig

    # Callback to update quotes table:
    @app.callback(Output('stock-quotes', 'data'), [Input("i_tris", "n_intervals")])
    def update_quotes(n):
        quotes = pd.read_sql('select * from quotes', connection)

        return quotes.to_dict('records')

    # Callback to update orders table:
    @app.callback(Output('stock-orders', 'data'), [Input("i_tris", "n_intervals")])
    def update_orders(n):
        orders = pd.read_sql('select * from orders', connection)

        return orders.to_dict('records')

except Exception as e:
    print("Error! Can't connect to database or General Exception. Invalid dbname, user or password, etc. ...")
    print(e)

finally:
    if (connection):
        connection.close()
        print("PostgreSQL connection is closed")
        print()

    print("Ending Mr. Nuertey Odzeyem's stock_trading Dash/PostgreSQL database test...")

if __name__ == "__main__":
    app.run_server(debug=True)
